
# es-bully 算法的简版实现ing....



### 大致流程:

1. 启动本地server节点,然后从配置文件中读取配置,创建长连接,节点启动时会为该节点分配一个id,bully算法采用的是pid.

2. 因为选举的过程时需要确定quorum数量的,如果本节点连接的channel数量低于quorum,则不会选举,一直等到channel数量大于等于quorum才会开始.

3. 对于某一个节点来说,如果是服务宕机,重新启动,当该节点发起选举时,别的节点需要告诉该节点,集群有master了,通常来说,一个已经选举成功的集群只会有一个master,否则会出现脑裂,在`findMaster`方法中.es的源码是用了一个容器保存从其他节点收到的主节点.所以这里我采用了类似的方法

4. 如果说是新集群启动,那该节点会依次询问其他节点,将它们看到的最小id节点信息发过来,在根据quorum数量判断是否作为候选master

5. 找出候选节点后,如果候选节点是当前节点,则等待其他的节点加入,否则就主动加入候选节点,这个是个一正一反的操作

6. 这个时候,如果该节点作为slave节点加入主节点成功,则开始ping主节点,一旦检测到master掉线,通过询问其他节点是否发现主节点掉线.超过半数发现主节点掉线,则开始重新选举

7. 如果该节点作为master,其他节点并加入成功,开始监听slave节点,并广播节点状态,哪些节点在线,哪些节点掉了